# Stars パズル ハンドオーバー文書

## パズルの概要
「あんたがた2026HP Stars」は、`stars.txt`（約400MB）のSKIコンビネータ計算プログラムを解析するパズル。プログラムを評価すると質問文を出力し、正しい「鍵文字列」を入力すると画像が生成される。その画像から最終回答を読み取るのがゴール。

## 現在の到達地点

### 完了していること
1. **SKI評価器の構築**: Rust製のグラフリダクション評価器を `ski_eval_rs/` に構築済み。arenaベース、遅延評価、fuel制限あり。
2. **I/Oプロトコルの解明**: pair1(pair1(p1,p2), Q) 構造でChurch数タグを使う。出力(p1=1)、入力(p1=2)、停止(p1=0)。
3. **I/Oフローの確認**: 空入力時 → 質問出力(33文字) → 鍵入力要求 → "wrong"出力(5文字) → 停止
4. **文字列デコード成功**: Convention B（pair_fst=rest, pair_snd=value）で33文字の質問文と5文字のエラーメッセージを取得。コード範囲は1-24。
5. **5文字の文字コード判明**: エラーメッセージ "wrong" がサーバー上で "M5PWz" と表示されることから:
   - 19→M→w, 20→5→r, 22→P→o, 9→W→n, 21→z→g

### 未完了（ここから先が必要）
1. **残り19文字のコード対応を解明する**
2. **質問文（33文字）を完全に解読する**
3. **質問に正しく答えて鍵文字列を特定する**
4. **鍵文字列を入力して画像を取得する**
5. **画像から最終回答を読み取る**

## 鍵になるデータ

### 質問文（内部コード列）
```
2, 8, 16, 5, 6, 20, 6, 19, 8, 22, 8, 19, 22, 21, 8, 24, 22, 23, 8, 19, 17, 1, 8, 7, 5, 17, 1, 22, 5, 8, 19, 6, 13
```
- 8=スペースと仮定すると8単語（長さ: 1-6-1-3-3-3-6-3）
- 既知の5文字で部分復号: `? ??_r_w o wog ?o? w?? ?_r??o_r w_?`

### サーバーの文字セット（28種）
```
& * , - 0 5 9 < C D F M P Q W X [ f j k l n o u w y z {
```

### 外部入手した全質問テキスト（サーバー表示文字）
```
cMPQP czMn5 e-nQPz lfXn& QP5959PX QnQ Qn&n-QPznk8(
czlWlQD cePX,P5 QPwF9zPX QnQ PX9M kPX QP5959PX QnQ &n-QPznk8
ezPX -nW Qnkn<lW uPXl-FXnuz QP5959PX QnQ Qn&n-QPznk8
cezPX -nW kn<lW 5959PX Qn&n-QPznk QPP9znX lf&n{QPX8
```

### 整数コンパクト表現（5進法ベース、サーバー記法）
```
0=Dlu, 1=Xn&, 2=PXz, 3=n9u, 4=zPQ, 5=uPX, ...
10=wn-, ..., 19=wn-uPXzlQ, 20=PXzn-wn-, ..., 24=PXzn-wn-zPQ
```

## 試して失敗したアプローチ

### 1. タイミングサイドチャネル攻撃
- keyfindモードとして実装済み（main.rs内）
- Step2のQ(λ)に各文字コードを適用し、ステップ数の差で正解文字を判別する想定
- 遅延評価のため比較が即座に発火せず、全文字で同一ステップ数になった
- 改良版（結果を深く強制評価）は実装済みだが未検証

### 2. サーバーブルートフォース
- 28有効文字の全組み合わせを試行
- **全ての非空入力に対して同一レスポンスが返る** → ブルートフォース不可能
- サーバーは入力内容に関わらず「鍵チェック→wrong」の結果を返す

## 推奨する次のアプローチ

### A. 質問文の解読（最有望）
- 外部入手のサーバー表示テキストを解析して、表示文字→英語の完全対応表を作る
- 「8(」区切りで4セクション、「c」で始まるパターンがある
- ここにコンパクト整数表現の知識を組み合わせると、数値リテラルを読み取れる可能性
- 質問が解読できれば、答え（=鍵文字列）を推測できる

### B. keyfindモードの改良
- Q(input)の結果をもっと深く強制評価する（出力文字列全体を評価するなど）
- 正解文字ならStep3で"wrong"以外が出るはず → ステップ数に差が出る

### C. サーバー表示文字と内部コードの対応解明
- コンパクト整数表現テーブルの記号（D,l,u,X,n,&,P,z,Q,w,9,-等）は全てサーバー有効文字に含まれる
- テーブルの構造（5進法）と、質問文テキスト中の数値リテラルを照合する

### D. 鍵チェック部分のSKI式を直接解読
- ヒント: 「鍵チェックの部分を解読したりすることで分かるぞ」
- I/O Step2のQ(λ)を解析し、比較対象の文字列を直接取り出す

## 重要な注意点

1. **Convention B**: 文字列リストは pair_fst=rest, pair_snd=value。ヒント記述とは逆。
2. **2種類のpair**: I/Oタプル（pair1, 1引数Scott）とリスト（pair2, 2引数Scott）は構造が異なる。
3. **Church数 vs 2の補数整数**: I/Oタグはchurch数、文字コードは2の補数ビット列。混同注意。
4. **サーバーの表示文字セット**: 通常のASCIIではなく、28種の特殊文字セットを使用。
5. **遅延評価**: SKI評価器は遅延グラフリダクション。比較などは結果が必要になるまで評価されない。

## ビルド・実行コマンド
```bash
# ビルド
cd ski_eval_rs && PATH="/c/Users/mizuki/.cargo/bin:$PATH" cargo build --release

# I/Oインタプリタ実行
./ski_eval_rs/target/release/ski-eval.exe very_large_txt/stars_compact.txt --fuel 2000000000 --decode io --img images/io_test

# 鍵探索（タイミング攻撃）
./ski_eval_rs/target/release/ski-eval.exe very_large_txt/stars_compact.txt --fuel 2000000000 --decode keyfind --img images/keyfind
```

## 主要ファイル
| ファイル | 説明 |
|---------|------|
| `ski_eval_rs/src/main.rs` | Rust SKI評価器（~3200行） |
| `very_large_txt/stars_compact.txt` | コンパクト形式のプログラム |
| `analysis_charcode.md` | 文字コード解析メモ |
| `reference/hint-new.md` | 最新GMヒント（最重要） |
| `send/send.js` | サーバー提出スクリプト（他プレイヤー作） |
| `scripts/test_server.js` | サーバーテスト用スクリプト |
